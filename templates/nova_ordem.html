<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Ordem</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        h1 {
            background-color: #333;
            color: #fff;
            padding: 10px;
            margin: 0;
            text-align: center;
        }

        h2 {
            margin-top: 20px;
        }

        ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            background-color: #555;
            overflow: hidden;
        }

        li {
            float: right;
        }

        li a {
            display: block;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
        }

        li a:hover {
            background-color: #4CAF50;
        }

        h1 {
            background-color: #333;
            color: #fff;
            padding: 10px;
            margin: 0;
            text-align: center;
        }

        form {
            margin-top: 20px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        label {
            display: block;
            margin-bottom: 8px;
        }

        select,
        input {
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }

        button:hover {
            background-color: #45a049;
        }

        #servicos_list {
            display: flex;
            flex-wrap: wrap;
            margin-top: 5px;
        }

        #servicos_list label {
            flex: 0 0 48%;
            margin-right: 2%;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        #servicos_list input {
            margin-right: 5px;
        }

        /* Novo estilo para a lista de serviços selecionados */
        #servicos-selecionados {
            list-style: none;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-width: 300px; /* Ajuste conforme necessário */
            margin-top: 10px;
        }

        #servicos-selecionados li {
            margin-bottom: 5px;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }
        
        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        
        .dropdown-content a:hover {background-color: #f1f1f1}
        
    </style>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>

<body>
    <h1>Petsoft</h1>
    <ul>
        <li><a href="/lista_clientes">Clientes</a></li>
        <li><a href="/lista_animais">Animais</a></li>
        <li><a href="/lista_servicos">Serviços</a></li>
        <li><a href="/agendamento">Agendamento</a></li>
        <li><a href="/index">Início</a></li>
    </ul>

    <h1>Nova Ordem de Serviço</h1>
    <form method="POST" action="/nova_ordem">
        <!-- Campos do formulário -->
        <label for="cliente-nome">Nome do Cliente:</label>
        <input type="text" id="cliente-nome" name="cliente_nome" autocomplete="off">

        <div id="cliente-dropdown" class="dropdown-content">
         <!-- Client names will be populated here -->
        </div>
        <input type="hidden" id="cliente-id" name="cliente_id">


        <label for="animal">Animal:</label>
        <select id="animal" name="animal" required>
            <!-- A lista de animais será preenchida dinamicamente via AJAX -->
        </select>

        <label for="servico-nome">Tipo de Serviço:</label>
        <input type="text" id="servico-nome" name="servico_tipo" autocomplete="off">
        <div id="servico-dropdown" class="dropdown-content">
         <!-- Service names will be populated here -->
        </div>


        <label for="servicos-selecionados">Serviços Selecionados:</label>
        <table id="servicos-selecionados">
            <thead>
                 <tr>
                     <th>Serviço</th>
                     <th>Valor</th>
                </tr>
            </thead>
            <tbody>
             <!-- Selected services will be appended here -->
            </tbody>
        </table>
        <input type="hidden" id="servicos-ids" name="servicos_ids" value="">


        <label for="valor-total">Valor Total:</label>
        <input type="text" id="valor-total" name="valor_total" readonly>

        <label for="data_ordem">Data da Ordem:</label>
        <input type="date" id="data_ordem" name="data_ordem" required>

        <label for="descricao">Descrição:</label>
        <textarea id="descricao" name="descricao" rows="4" cols="50" placeholder="Digite a descrição"></textarea>

        <!-- Adicione outros campos conforme necessário -->


        <button type="submit">Salvar Ordem</button>
    </form>

    <script>
        $(document).ready(function () {
            // Variável para armazenar os serviços selecionados
            var servicosSelecionados = [];

            // Ao selecionar um cliente, atualiza a lista de animais
            $('#cliente').change(function () {
                var clienteId = $(this).val();
                $.ajax({
                    type: 'GET',
                    url: '/get_animais_por_cliente/' + clienteId,
                    success: function (data) {
                        // Limpa a lista de animais
                        $('#animal').empty();
                        // Adiciona os novos animais à lista
                        $.each(data.animais, function (index, animal) {
                            $('#animal').append('<option value="' + animal.id + '">' + animal.nome + '</option>');
                        });
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
            });

            // Ao clicar duas vezes em um serviço, adiciona ou remove da lista de serviços selecionados
            $('#servicos').dblclick(function () {
                var selectedServiceId = $(this).val();
                var selectedServiceText = $('#servicos option:selected').text();

                // Verifica se o serviço já está na lista de serviços selecionados
                var index = servicosSelecionados.findIndex(function (service) {
                    return service.id === selectedServiceId;
                });

                if (index === -1) {
                    // Adiciona o serviço à lista de serviços selecionados
                    servicosSelecionados.push({
                        id: selectedServiceId,
                        text: selectedServiceText
                    });
                } else {
                    // Remove o serviço da lista de serviços selecionados
                    servicosSelecionados.splice(index, 1);
                }

                // Atualiza a lista de serviços selecionados
                atualizarListaServicosSelecionados();
            });

            // Botão para adicionar serviço
            $('#adicionar-servico').click(function () {
                // Obtenha o serviço selecionado
                var selectedService = $('#servicos :selected');

                // Adicione o serviço à lista de serviços selecionados
                servicosSelecionados.push({
                    id: selectedService.val(),
                    text: selectedService.text()
                });

                // Atualize a lista de serviços selecionados
                atualizarListaServicosSelecionados();
            });

            // Botão para remover serviço
            $('#remover-servico').click(function () {
                // Obtenha o serviço selecionado
                var selectedService = $('#servicos-selecionados :selected');

                // Remova o serviço da lista de serviços selecionados
                servicosSelecionados = servicosSelecionados.filter(function (service) {
                    return service.id !== selectedService.val();
                });

                // Atualize a lista de serviços selecionados
                atualizarListaServicosSelecionados();
            });

            // Atualiza a lista de serviços selecionados
            function atualizarListaServicosSelecionados() {
                $('#servicos-selecionados').empty();
                var valorTotal = 0;

                $.each(servicosSelecionados, function (index, service) {
                    $('#servicos-selecionados').append('<li>' + service.text + '</li>');
                    // Adiciona o valor do serviço ao valor total
                    valorTotal += parseFloat(service.text.split('R$ ')[1]);
                });

                // Exibe o valor total
                $('#valor-total').val('R$ ' + valorTotal.toFixed(2));
            }
        });
    </script>
    <script>
        $(document).ready(function () {
            $('#cliente-nome').keyup(function () {
                var query = $(this).val();
        
                if (query.length > 0) {
                    $.ajax({
                        url: '/buscar_clientes_por_nome',
                        method: 'GET',
                        data: { 'nome': query },
                        success: function (data) {
                            $('#cliente-dropdown').empty().show();
                            $.each(data.clientes, function (index, cliente) {
                                $('#cliente-dropdown').append('<a href="#" onclick="selectClient(\'' + cliente.idCliente + '\', \'' + cliente.nome + '\')">' + cliente.nome + '</a>');
                            });
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                } else {
                    $('#cliente-dropdown').hide();
                }
            });
        });
        
    </script>    
    <script>
        function selectClient(clientId, clientName) {
            // Set the input field with the selected client's name
            $('#cliente-nome').val(clientName);
        
            // Set the hidden input field's value with the selected client's ID
            $('#cliente-id').val(clientId);
        
            // Fetch animals related to the selected client
            fetchAnimalsForClient(clientId);
        
            // Hide the dropdown after selection
            $('#cliente-dropdown').hide();
        }
        
    </script>
    <script>
        function fetchAnimalsForClient(clientId) {
            $.ajax({
                type: 'GET',
                url: '/get_animais_por_cliente/' + clientId, // Ensure this route is correctly defined in your Flask app
                success: function(data) {
                    // Clear the current options in the animal select
                    $('#animal').empty();
        
                    // Add new options to the animal select
                    $.each(data.animais, function(index, animal) {
                        $('#animal').append('<option value="' + animal.id + '">' + animal.nome + '</option>');
                    });
                },
                error: function(error) {
                    console.log(error);
                }
            });
        }
        
    </script>

    <script>
   
    </script>
    <script>
        
        
    </script>
    <script>
        function atualizarListaServicosSelecionados() {
            var tbody = $('#servicos-selecionados tbody');
            tbody.empty();
            var valorTotal = 0;
        
            $.each(servicosSelecionados, function(index, service) {
                var serviceDetails = service.text.split(' - R$ ');
                var serviceName = serviceDetails[0];
                var serviceValue = parseFloat(serviceDetails[1]);
                valorTotal += serviceValue;
        
                tbody.append('<tr><td>' + serviceName + '</td><td>R$ ' + serviceValue.toFixed(2) + '</td></tr>');
            });
        
            $('#valor-total').val('R$ ' + valorTotal.toFixed(2));
        }
        
        
    </script>  
    <script>
        $(document).ready(function () {
            var servicosSelecionados = [];
        
            // Função para adicionar serviço à tabela
            function adicionarServicoTabela(serviceId, serviceInfo) {
                var serviceAlreadySelected = servicosSelecionados.some(service => service.id === serviceId);
                if (!serviceAlreadySelected) {
                    servicosSelecionados.push({ id: serviceId, text: serviceInfo });
                    
                    var serviceDetails = serviceInfo.split(' - R$ ');
                    var serviceName = serviceDetails[0];
                    var serviceValue = parseFloat(serviceDetails[1]);
                    
                    var tbody = $('#servicos-selecionados tbody');
                    tbody.append('<tr><td>' + serviceName + '</td><td>R$ ' + serviceValue.toFixed(2) + '</td></tr>');
            
                    // Atualiza o campo oculto com os IDs dos serviços selecionados
                    $('#servicos-ids').val(servicosSelecionados.map(s => s.id).join(','));
            
                    atualizarValorTotal();
                }
            }
            function selectService(serviceId, serviceInfo) {
                var serviceAlreadySelected = servicosSelecionados.some(service => service.id === serviceId);
                if (!serviceAlreadySelected) {
                    servicosSelecionados.push({ id: serviceId, text: serviceInfo });
                    atualizarListaServicosSelecionados();
                }
                $('#servico-dropdown').hide();
            }
            $('#servico-nome').keyup(function() {
                var query = $(this).val();
            
                if (query.length > 0) {
                    $.ajax({
                        url: '/buscar_servicos', // Endpoint to fetch services
                        method: 'GET',
                        data: { 'query': query },
                        success: function(data) {
                            $('#servico-dropdown').empty().show();
                            $.each(data.servicos, function(index, servico) {
                                var servicoInfo = servico.tipo + ' - R$ ' + servico.valor;
                                $('#servico-dropdown').append('<a href="#" data-id="' + servico.id + '">' + servicoInfo + '</a>');
                            });
    
                            // Anexar evento de clique após adicionar os links
                            $('#servico-dropdown').on('click', 'a', function(e) {
                                e.preventDefault();
                                var serviceId = $(this).data('id');
                                var serviceInfo = $(this).text();
                                selectService(serviceId, serviceInfo);
                            });
                        },
                        error: function(error) {
                            console.log(error);
                        }
                    });
                } else {
                    $('#servico-dropdown').hide();
                }
            });
    
            
            
        
            // Função para atualizar o valor total
            function atualizarValorTotal() {
                var valorTotal = servicosSelecionados.reduce((total, service) => {
                    var serviceValue = parseFloat(service.text.split(' - R$ ')[1]);
                    return total + serviceValue;
                }, 0);
        
                $('#valor-total').val('R$ ' + valorTotal.toFixed(2));
            }
        
            // Evento de clique para adicionar serviços
            $('#servico-dropdown').on('click', 'a', function(e) {
                e.preventDefault();
                var serviceId = $(this).data('id');
                var serviceInfo = $(this).text();
                adicionarServicoTabela(serviceId, serviceInfo);
            });
        
            // Eventos AJAX e outros códigos...
        });
        
    </script>            
    <script src="path/to/your/scripts.js"></script>
</body>

</html>